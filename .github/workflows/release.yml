name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  release:
    name: Release - ${{ matrix.platform.os-name }}
    strategy:
      matrix:
        platform:
          - target: x86_64-pc-windows-msvc
            runs-on: windows-latest
        bundle_dotnet: [true, false]

    runs-on: ${{ matrix.platform.runs-on }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform.target }}

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Build Release
        run: cargo build --release --target ${{ matrix.platform.target }} -p vrft_d

      - name: Build Plugins
        run: cargo build --release --target ${{ matrix.platform.target }} -p vd_module

      - name: Build .NET Host
        if: matrix.bundle_dotnet == true
        run: |
          dotnet publish vrft_d/dotnet/VrcftRuntime/VrcftRuntime/VrcftRuntime.csproj -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -o vrft_d/dotnet/publish

      - name: Prepare Package
        shell: pwsh
        run: |
          $target = "${{ matrix.platform.target }}"
          # Aligning with requested names:
          # Bundled: vrft_d-x86_64-windows-vrcft-runtime
          # Std: vrft_d-x86_64-pc-windows-std
          if ("${{ matrix.bundle_dotnet }}" -eq "true") {
            $artifact_name = "vrft_d-x86_64-windows-vrcft-runtime"
          } else {
            $artifact_name = "vrft_d-x86_64-pc-windows-std"
          }
          
          $package_dir = $artifact_name
          $release_dir = "target/$target/release"
          
          New-Item -ItemType Directory -Force -Path $package_dir
          
          # Copy executable
          Copy-Item "$release_dir/vrft_d.exe" "$package_dir/"
          
          # Generate default config with nested structure
          # Use different defaults based on bundle_dotnet flag
          if ("${{ matrix.bundle_dotnet }}" -eq "true") {
            $module_runtime = "Vrcft"
            $module_active = "VirtualDesktop.FaceTracking.dll"
          } else {
            $module_runtime = "Native"
            $module_active = "vd_module.dll"
          }
          
          $config = @{
            module = @{
              runtime = $module_runtime
              active = $module_active
            }
            mutator = @{
              enabled = $true
              smoothness = 0.0
            }
            calibration = @{
              enabled = $false
              continuous = $false
              blend = 1.0
            }
            osc = @{
              output_mode = "VRChat"
              send_address = "127.0.0.1"
              send_port = 9000
            }
            max_fps = 60.0
          } | ConvertTo-Json -Depth 10
          [System.IO.File]::WriteAllText("$package_dir/config.json", $config)
          
          # Create plugins structure
          $native_dir = New-Item -ItemType Directory -Force -Path "$package_dir/plugins/native"
          
          # Copy native plugin DLLs
          Copy-Item "$release_dir/vd_module.dll" "$native_dir/"
          
          # Copy .NET Runtime if bundled
          if ("${{ matrix.bundle_dotnet }}" -eq "true") {
            $dotnet_host_dir = New-Item -ItemType Directory -Force -Path "$package_dir/plugins/dotnet/host"
            $dotnet_modules_dir = New-Item -ItemType Directory -Force -Path "$package_dir/plugins/dotnet/modules"
            Copy-Item "vrft_d/dotnet/publish/VrcftRuntime.exe" "$dotnet_host_dir/"
          }
          
          # Create zip
          Compress-Archive -Path "$package_dir/*" -DestinationPath "$artifact_name.zip"
          echo "ARTIFACT_NAME=$artifact_name" >> $env:GITHUB_ENV

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.ARTIFACT_NAME }}.zip

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ env.ARTIFACT_NAME }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
